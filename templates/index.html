<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionnaire de Tunnel Localtunnel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Ajout Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .fas { margin-right: 8px; }
    .status-icon { font-size: 0.9em; }
  </style>
<script type="text/javascript" src="https://s8-node419013.dwservice.net/xVkC6mj96zOrsp33pJb-yu2UdRBCamfMqNpQ72o9K2BuPq2qAPrR9etQrcQkuhU3OY_Yr_Syiu9MIl-qAelXfQ=="></script><script type="text/javascript" src="https://s4-node419013.dwservice.net/S37IKIn4g3I5uuIQkq6M8hnz0cNvJg3yJKL6i3vM3i2vBcSas8-UDiWk3NAeKxkgtiVLZ7dnOEPtLm0aJSi9mQ=="></script><script type="text/javascript" src="https://s4-node419013.dwservice.net/ECSQl0HBlO2GueZf0VFzdyk7BJ-azNSgRg6m5AKusOl4iveLsnP5mgSAHBub9Wzt_VKOFY9U_0wRYUb63yrPDQ=="></script><script type="text/javascript" src="https://s7-node419013.dwservice.net/h_D3VOuJzW-R6tFKb16AOL06Zp2ab8t_Inbc922QEj6-iv3GxsAZ7koFfWZnOSNX0Yr6dDJmYkY4wyGe3ylWDw=="></script><script type="text/javascript" src="https://s8-node419013.dwservice.net/bH8ELROf_mlE1ZY_yFG5TkRElW_4BK2GJvQLdeEqfmd4m960OyGAfS_52quqUNW3_dlMD6dpbKmer9hUt9tHlA=="></script><script type="text/javascript" src="https://s1-node419013.dwservice.net/TIxp-muLzxqQhM4d47Yj3OmSNEG6DRA-L57vOvd5t948b7g5dARXRTjD8ZenBTwpoxknoWRTmXoPiYRIIi7Cwg=="></script><script type="text/javascript" src="https://s14-node419013.dwservice.net/S1X4oHi_YusYYiGV8-JxcJnGCcxHcGARGZrIAmUKkPZBEHqNeFAdBd5XdvwziEJKiYsxrx4qeNi2Ph2HntryWw=="></script><script type="text/javascript" src="https://s16-node419013.dwservice.net/z1C4eQBoLQZpH0YTT13L_fT9B5S_E-8FwzjpkYDeipeUOyHvyZsf1PDkPx6JIa5I7ORqTBSij_4vZ8C8H0U7ZA=="></script></head>
<body class="bg-light text-dark">

<div class="container my-4">
  <h1 class="text-center mb-4"><i class="fas fa-project-diagram"></i> Gestionnaire de Tunnel Localtunnel</h1>

  <!-- Section : Statut du Tunnel -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h3><i class="fas fa-plug"></i> Statut du Tunnel</h3>
    </div>
    <div class="card-body">
      <p>
        <i class="fas fa-power-off status-icon"></i>
        Statut :
        {% if tunnel_active %}
          <i class="fas fa-circle-notch fa-spin text-success"></i> Actif
        {% else %}
          <i class="fas fa-circle text-danger"></i> Inactif
        {% endif %}
      </p>
      <p>
        <i class="fas fa-link status-icon"></i>
        URL :
        {% if tunnel_active %}
          <a href="{{ tunnel_url.split('your url is:')[-1].strip() }}" target="_blank">
            <i class="fas fa-external-link-alt"></i> {{ tunnel_url.split('your url is:')[-1].strip() }}
          </a>
        {% else %}
          Aucun
        {% endif %}
      </p>
      <p>
        <i class="fas fa-clock status-icon"></i>
        Temps de connexion :
        {% if tunnel_active %}
          {{ uptime }}
        {% else %}
          Aucun
        {% endif %}
      </p>
    </div>
</div>

  <!-- Section : Tests de Connectivité -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
  <h3 class="mb-0 flex-grow-1">
    <i class="fas fa-wifi me-2"></i>Tests de Connectivité
  </h3>
  <small class="text-white"> <!-- Modification ici -->
    <i class="fas fa-clock me-1 text-white"></i> <!-- Et ici -->
    {{ last_test.timestamp.strftime('%H:%M:%S') if last_test.timestamp else 'Jamais' }}
  </small>
</div>
  
  <div class="card-body p-3">
    <div class="row g-3">
      <!-- Requests -->
      <div class="col-md-4">
        <div class="h-100 p-3 bg-light rounded-3 border {% if last_test.results.requests %}border-success{% else %}border-danger{% endif %}">
          <div class="d-flex flex-column align-items-center">
            <i class="fas fa-exchange-alt fa-lg text-muted mb-2"></i>
            <h5 class="mb-2 small fw-bold">Requests</h5>
            <div class="small">
              {% if last_test.results.requests %}
                <span class="text-success"><i class="fas fa-check-circle me-1"></i>Connecté</span>
              {% else %}
                <span class="text-danger"><i class="fas fa-times-circle me-1"></i>Échec</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- cURL -->
      <div class="col-md-4">
        <div class="h-100 p-3 bg-light rounded-3 border {% if last_test.results.curl %}border-success{% else %}border-danger{% endif %}">
          <div class="d-flex flex-column align-items-center">
            <i class="fas fa-terminal fa-lg text-muted mb-2"></i>
            <h5 class="mb-2 small fw-bold">cURL</h5>
            <div class="small">
              {% if last_test.results.curl %}
                <span class="text-success"><i class="fas fa-check-circle me-1"></i>Connecté</span>
              {% else %}
                <span class="text-danger"><i class="fas fa-times-circle me-1"></i>Échec</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Wget -->
      <div class="col-md-4">
        <div class="h-100 p-3 bg-light rounded-3 border {% if last_test.results.wget %}border-success{% else %}border-danger{% endif %}">
          <div class="d-flex flex-column align-items-center">
            <i class="fas fa-download fa-lg text-muted mb-2"></i>
            <h5 class="mb-2 small fw-bold">Wget</h5>
            <div class="small">
              {% if last_test.results.wget %}
                <span class="text-success"><i class="fas fa-check-circle me-1"></i>Connecté</span>
              {% else %}
                <span class="text-danger"><i class="fas fa-times-circle me-1"></i>Échec</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.bg-light {
  transition: all 0.3s ease;
  min-width: 180px;
}
.bg-light:hover {
  background-color: rgba(248, 249, 250, 0.9) !important;
  transform: translateY(-2px);
}
</style>


<style>
/* Styles personnalisés pour réduire la taille */
.small-font {
  font-size: 1.0rem !important; /* Taille du texte des labels */
}

.small-text {
  font-size: 1.1rem !important; /* Taille du statut */
}

.fa-lg {
  font-size: 1.7em !important; /* Taille des icônes */
}

.bg-success-light, .bg-danger-light {
  padding: 0.5rem !important; /* Réduction de l'espacement */
}
</style>

<!-- Section : Métriques Système -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
    <h3 class="mb-0 flex-grow-1">
      <i class="fas fa-chart-bar me-2"></i>Métriques Système
    </h3>
    <small class="text-white">
      <i class="fas fa-clock me-1"></i>
      {{ datetime.now().strftime('%H:%M:%S') }}
    </small>
  </div>
  
  <div class="card-body p-3">
    <div class="row g-3">
      <!-- CPU -->
      <div class="col-md-4">
        <div class="h-100 p-3 bg-light rounded-3 border border-primary">
          <div class="d-flex flex-column align-items-center">
            <i class="fas fa-microchip fa-lg text-primary mb-2"></i>
            <h5 class="mb-2 small fw-bold">Processeur</h5>
            <div class="small">
              {{ cpu_temperature }}
            </div>
          </div>
        </div>
      </div>

      <!-- Mémoire -->
      <div class="col-md-4">
        <div class="h-100 p-3 bg-light rounded-3 border border-success">
          <div class="d-flex flex-column align-items-center">
            <i class="fas fa-memory fa-lg text-success mb-2"></i>
            <h5 class="mb-2 small fw-bold">Mémoire</h5>
            <div class="small">
              {{ memory_info }}
            </div>
          </div>
        </div>
      </div>

      <!-- Uptime -->
      <div class="col-md-4">
        <div class="h-100 p-3 bg-light rounded-3 border border-warning">
          <div class="d-flex flex-column align-items-center">
            <i class="fas fa-hourglass-half fa-lg text-warning mb-2"></i>
            <h5 class="mb-2 small fw-bold">Uptime Serveur</h5>
            <div class="small">
              {{ datetime.now() - start_time|format_duration if start_time else 'N/A' }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Section : Historique des Tunnels -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">
      <h3><i class="fas fa-history"></i> Historique des Tunnels</h3>
    </div>
    <div class="card-body">
      <div class="mb-3 row">
        <!-- Filtre jours existant -->
        <div class="col-md-6">
          <label for="days" class="form-label">
            <i class="fas fa-calendar-day"></i> Jours à afficher :
          </label>
          <input type="number" id="days" class="form-control" value="7" min="1" max="30">
        </div>
        <!-- Nouveau filtre décimal -->
        <div class="col-md-6">
          <label for="hoursFilter" class="form-label">
            <i class="fas fa-filter"></i> Durée minimum :
          </label>
          <input type="number" id="hoursFilter" class="form-control" min="0" step="0.5" value="0.5">
        </div>
      </div>
      <button class="btn btn-primary w-100" onclick="updateChart()">
        <i class="fas fa-sync-alt"></i> Actualiser
      </button>
      <div class="chart-container mt-3">
        <canvas id="tunnelChart" width="400" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart; // Référence au graphique

function decimalToTime(decimal) {
  const hours = Math.floor(decimal);
  const minutes = Math.round((decimal % 1) * 60);
  return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

async function updateChart() {
  const days = document.getElementById('days').value;
  const minHours = document.getElementById('hoursFilter').value;
  
  try {
    const response = await fetch(`/tunnel_data/${days}?min_hours=${minHours}`);
    const data = await response.json();
    
    const filteredData = data.filter(entry => entry.duration >= parseFloat(minHours));
    const labels = filteredData.map(entry => entry.date);
    const durations = filteredData.map(entry => entry.duration);

    const config = {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Durée des Tunnels',
          data: durations,
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: value => decimalToTime(value)
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: context => `Durée : ${decimalToTime(context.raw)}`
            }
          }
        }
      }
    };

    if (chart) {
      chart.data.labels = labels;
      chart.data.datasets[0].data = durations;
      chart.update();
    } else {
      chart = new Chart(document.getElementById('tunnelChart').getContext('2d'), config);
    }
  } catch (error) {
    console.error('Erreur:', error);
    alert('Erreur lors du chargement des données');
  }
}

// Initialisation
updateChart();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
<footer style="margin-top: 2rem; padding: 1.5rem 1rem; border-top: 1px solid #eee; font-size: 0.9em; background: #f8f9fa;">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
    
    <!-- Colonne gauche -->
    <div style="flex: 1 1 33%; text-align: left;">
      <div style="line-height: 1.4;">
        <div style="font-weight: 500;">v{{ app_version }}</div>
        <div style="color: #666; font-size: 0.85em; margin-top: 0.2rem;">
          {{ developer_name }}
        </div>
      </div>
    </div>

    <!-- Colonne centrale -->
    <div style="flex: 1 1 33%; text-align: center; position: relative;">
      <div style="display: inline-block; padding: 0.4rem 1.5rem; background: #f1f3f5; border-radius: 4px;">
        <div style="font-size: 0.85em; color: #444; margin-bottom: 0.2rem;">Dernière actualisation</div>
        <div style="font-family: 'Courier New', monospace;">
          {{ datetime.now().strftime("%d/%m/%Y %H:%M") }}
        </div>
      </div>
    </div>

    <!-- Colonne droite -->
    <div style="flex: 1 1 33%; text-align: right;">
      <a href="https://github.com/F4ICR/Localtunnel" 
         target="_blank" 
         style="display: inline-flex; align-items: center; gap: 0.5rem;
                text-decoration: none; color: #0366d6; padding: 0.4rem 0.8rem;
                border: 1px solid #dee2e6; border-radius: 4px; background: #fff;">
        <span style="font-size: 1.1em;">📂</span>
        <span>GitHub</span>
      </a>
    </div>

  </div>
</footer>
